name: x86-64 Pull and Save Docker Image
on:
  workflow_dispatch:
    inputs:
      docker_images:
        description: '请填写docker镜像名称 多个用英文逗号分开'
        required: true
        default: 'alpine:latest'

jobs:
  pull_and_package:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    # === 释放 GitHub Actions 磁盘空间（非常关键） ===
    - name: Free disk space
      run: |
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /usr/local/share/boost
        sudo rm -rf /usr/local/lib/node_modules
        sudo rm -rf /opt/ghc
        docker system prune -af
        docker volume prune -f
        df -h

    # === 逐个拉取、保存、压缩镜像，避免占用过多磁盘 ===
    - name: Pull and save images
      run: |
        images="${{ github.event.inputs.docker_images }}"
        IFS=',' read -r -a array <<< "$images"
        mkdir saved

        for image in "${array[@]}"; do
          img="$(echo $image | xargs)"
          echo "Pulling $img ..."
          docker pull "$img" --platform linux/amd64

          file="${img//\//_}-amd64.tar"
          docker save "$img" -o "$file"

          echo "Compressing $file ..."
          gzip "$file"

          mv "$file.gz" saved/

          # 删除 Docker 缓存，避免空间爆炸
          docker image rm "$img" || true
          docker system prune -af || true
          df -h
        done

    - name: Create final package
      run: |
        tar -czf x86-64-images.tar.gz saved

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: docker-images-tar
        path: x86-64-images.tar.gz
        retention-days: 1
